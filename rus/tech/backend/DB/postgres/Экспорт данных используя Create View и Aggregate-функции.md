пятница, 15 февраля 2008 г. в 11:32:11

Встала задача экспортирования данных из таблицы _Firma_ в качестве строки. Если бы дело было в одноразовом копировании то проблемы особой и не-было бы - всегда есть клиентские программы, которые экспортируют хоть в Excel, хоть в текстовый файл какие угодно колонки. Но мне необходимо было это сделать при помощи SQL, потому что прямого доступа к live-базе данных у меня нет, а размер таблицы мне неизвестен.

Вход - таблица Firma

| ID  | name      |
| --- | --------- |
| 1   | Google    |
| 2   | Microsoft |
Выход - строка
```
1=>Google;2=>Microsoft
```


[Агрегирующие функции](http://www.postgresql.org/docs/8.0/interactive/sql-createaggregate.html) занимаются именно такой задачей - на входе у них массив данных, а на выходе - одно значение. Типичным примером являются функции COUNT, MAX, SUM. Postgre пошла по пути универсальности и позволяет пользователю самому создавать такие функции. Создаём CONCAT функцию:

```sql
CREATE AGGREGATE concat (  
BASETYPE = text,  
SFUNC = textcat,  
STYPE = text,  
INITCOND = ''  
);
```

Теперь можно сразу получить строку с данными, но мне нужна сортировка по названию фирмы, но никакие вложенные запросы и ORDER BY этому не помогают:

`SELECT CONCAT(name||';') FROM Firma;`

Поэтому приходится изучить ещё одну новую для себя функциональность и создать Представление ([View](http://www.postgresql.org/docs/8.0/interactive/sql-createview.html)). View это виртуальная таблица, данные которой формируются на лету. Она может использоваться и в качестве ограничения прав на изменение родительской таблицы. Представления можно кэшировать - тн. [материализация](http://en.wikipedia.org/wiki/Materialized_view). Но сейчас оно поможет реализовать обычную сортировку:

`CREATE VIEW FirmaSorted AS SELECT * FROM Firma ORDER BY name;`

Остаётся сделать выборку, в которую я добавлю ещё одно поле, уберу последний символ-разделитель и сделаю UPDATE полученного значения в другую таблицу:

```sql
UPDATE tblLists SET strValue=(  
SELECT TRIM(';' FROM (SELECT CONCAT(id||'=>'||name||';') FROM FirmaSorted))  
) WHERE strName='companies';
```
```